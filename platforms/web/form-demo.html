<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zylix Form Demo</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      min-height: 100vh;
      padding: 20px;
    }
    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 30px;
    }
    .demos {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .demo-card {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 25px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .demo-card h3 {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .demo-card h3 span {
      background: linear-gradient(135deg, #667eea, #764ba2);
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #aaa;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(0,0,0,0.3);
      color: #fff;
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }
    input.error, select.error, textarea.error {
      border-color: #ef4444;
    }
    input.valid {
      border-color: #10b981;
    }
    .error-message {
      color: #ef4444;
      font-size: 12px;
      margin-top: 4px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    button.primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    button.primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button.primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button.secondary {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    button.secondary:hover {
      background: rgba(255,255,255,0.2);
    }
    button.danger {
      background: #ef4444;
      color: white;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .form-state {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    .form-state pre {
      white-space: pre-wrap;
      word-break: break-all;
    }
    .field-array-item {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }
    .field-array-item input {
      flex: 1;
    }
    .field-array-item button {
      padding: 8px 12px;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .checkbox-group input[type="checkbox"] {
      width: auto;
    }
    .success-message {
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid #10b981;
      color: #10b981;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      text-align: center;
    }
    .password-strength {
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      margin-top: 5px;
      overflow: hidden;
    }
    .password-strength-bar {
      height: 100%;
      transition: width 0.3s, background 0.3s;
    }
    .strength-weak { background: #ef4444; width: 33%; }
    .strength-medium { background: #f59e0b; width: 66%; }
    .strength-strong { background: #10b981; width: 100%; }
    .async-indicator {
      display: inline-block;
      width: 16px;
      height: 16px;
      margin-left: 8px;
      vertical-align: middle;
    }
    .async-indicator.loading {
      border: 2px solid rgba(255,255,255,0.2);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .async-indicator.valid::after { content: '✓'; color: #10b981; }
    .async-indicator.invalid::after { content: '✗'; color: #ef4444; }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>Zylix Form Demo</h1>
  <p class="subtitle">React-hook-form inspired form management with validation</p>

  <div class="demos">
    <div class="demo-card" id="signup-demo">
      <h3><span>1</span> Signup Form with Validation</h3>
      <!-- Rendered by JS -->
    </div>

    <div class="demo-card" id="async-demo">
      <h3><span>2</span> Async Validation</h3>
      <!-- Rendered by JS -->
    </div>

    <div class="demo-card" id="array-demo">
      <h3><span>3</span> Dynamic Field Array</h3>
      <!-- Rendered by JS -->
    </div>

    <div class="demo-card" id="complex-demo">
      <h3><span>4</span> Complex Form with All Features</h3>
      <!-- Rendered by JS -->
    </div>
  </div>

  <script type="module">
    // ========================================
    // Inline Form Implementation
    // ========================================

    // Built-in Validators
    const validators = {
      required: (message = 'This field is required') => ({
        validate: (value) => {
          if (value === null || value === undefined) return false;
          if (typeof value === 'string') return value.trim().length > 0;
          if (Array.isArray(value)) return value.length > 0;
          return true;
        },
        message
      }),

      email: (message = 'Please enter a valid email address') => ({
        validate: (value) => {
          if (!value || typeof value !== 'string') return true;
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailRegex.test(value);
        },
        message
      }),

      minLength: (min, message) => ({
        validate: (value) => {
          if (!value || typeof value !== 'string') return true;
          return value.length >= min;
        },
        message: message || `Must be at least ${min} characters`
      }),

      maxLength: (max, message) => ({
        validate: (value) => {
          if (!value || typeof value !== 'string') return true;
          return value.length <= max;
        },
        message: message || `Must be at most ${max} characters`
      }),

      pattern: (regex, message = 'Invalid format') => ({
        validate: (value) => {
          if (!value || typeof value !== 'string') return true;
          return regex.test(value);
        },
        message
      }),

      match: (fieldName, message) => ({
        validate: (value, formValues) => value === formValues[fieldName],
        message: message || `Must match ${fieldName}`
      }),

      min: (minValue, message) => ({
        validate: (value) => {
          if (value === null || value === undefined || value === '') return true;
          const num = typeof value === 'number' ? value : parseFloat(String(value));
          return !isNaN(num) && num >= minValue;
        },
        message: message || `Must be at least ${minValue}`
      }),

      custom: (validateFn, message) => ({
        validate: validateFn,
        message
      }),

      async: (validateFn, message) => ({
        validate: async (value) => {
          if (!value) return true;
          return await validateFn(value);
        },
        message
      })
    };

    // Deep clone utility
    function deepClone(obj) {
      if (obj === null || typeof obj !== 'object') return obj;
      if (obj instanceof Date) return new Date(obj.getTime());
      if (Array.isArray(obj)) return obj.map(deepClone);
      const cloned = {};
      for (const key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key)) {
          cloned[key] = deepClone(obj[key]);
        }
      }
      return cloned;
    }

    function isEqual(a, b) {
      return JSON.stringify(a) === JSON.stringify(b);
    }

    function generateId() {
      return Math.random().toString(36).substring(2, 11);
    }

    // useForm hook
    function useForm(config) {
      const { defaultValues, validation = {}, mode = 'onSubmit' } = config;

      let values = deepClone(defaultValues);
      let initialValues = deepClone(defaultValues);
      const errors = {};
      const touched = {};
      const dirty = {};
      const fieldConfigs = {};
      const fieldRefs = {};
      const listeners = new Set();

      let isSubmitting = false;
      let isValidating = false;
      let submitCount = 0;

      const notify = () => listeners.forEach(l => l());

      const validateField = async (name) => {
        const fieldValidation = validation[name] || fieldConfigs[name]?.validation || [];
        const value = values[name];

        for (const rule of fieldValidation) {
          try {
            const isValid = await rule.validate(value, values);
            if (!isValid) {
              return typeof rule.message === 'function' ? rule.message(value) : rule.message;
            }
          } catch (e) {
            return 'Validation error';
          }
        }
        return null;
      };

      const validateAll = async () => {
        isValidating = true;
        notify();

        let isValid = true;
        for (const name of Object.keys(values)) {
          const error = await validateField(name);
          if (error) {
            errors[name] = error;
            isValid = false;
          } else {
            delete errors[name];
          }
        }

        isValidating = false;
        notify();
        return isValid;
      };

      const register = (name, config = {}) => {
        fieldConfigs[name] = config;
        if (config.defaultValue !== undefined && values[name] === undefined) {
          values[name] = config.defaultValue;
        }

        return {
          name,
          value: values[name],

          onChange: (e) => {
            let newValue;
            if (e && typeof e === 'object' && 'target' in e) {
              const target = e.target;
              if (target.type === 'checkbox') {
                newValue = target.checked;
              } else if (target.type === 'number') {
                newValue = target.value === '' ? '' : parseFloat(target.value);
              } else {
                newValue = target.value;
              }
            } else {
              newValue = e;
            }

            values[name] = newValue;
            dirty[name] = !isEqual(newValue, initialValues[name]);

            const shouldValidate = mode === 'onChange' || mode === 'all' ||
              config.validateOnChange || (touched[name] && Object.keys(errors).length > 0);

            if (shouldValidate) {
              validateField(name).then(error => {
                if (error) errors[name] = error;
                else delete errors[name];
                notify();
              });
            } else {
              notify();
            }
          },

          onBlur: () => {
            touched[name] = true;
            const shouldValidate = mode === 'onBlur' || mode === 'all' || config.validateOnBlur;
            if (shouldValidate) {
              validateField(name).then(error => {
                if (error) errors[name] = error;
                else delete errors[name];
                notify();
              });
            } else {
              notify();
            }
          },

          ref: (el) => { if (el) fieldRefs[name] = el; }
        };
      };

      const setValue = (name, value, options = {}) => {
        values[name] = value;
        if (options.shouldDirty !== false) {
          dirty[name] = !isEqual(value, initialValues[name]);
        }
        if (options.shouldValidate) {
          validateField(name).then(error => {
            if (error) errors[name] = error;
            else delete errors[name];
            notify();
          });
        } else {
          notify();
        }
      };

      const reset = (newValues) => {
        if (newValues) {
          values = { ...deepClone(defaultValues), ...newValues };
          initialValues = deepClone(values);
        } else {
          values = deepClone(defaultValues);
          initialValues = deepClone(defaultValues);
        }
        for (const key in errors) delete errors[key];
        for (const key in touched) delete touched[key];
        for (const key in dirty) delete dirty[key];
        notify();
      };

      const handleSubmit = (onValid, onInvalid) => {
        return async (e) => {
          if (e) e.preventDefault();
          submitCount++;
          isSubmitting = true;
          notify();

          const isValid = await validateAll();
          if (isValid) {
            try {
              await onValid(deepClone(values));
            } catch (error) {
              console.error('Form submission error:', error);
            }
          } else {
            onInvalid?.(errors);
            const firstError = Object.keys(errors)[0];
            if (firstError && fieldRefs[firstError]) {
              fieldRefs[firstError].focus();
            }
          }

          isSubmitting = false;
          notify();
        };
      };

      const useFieldArray = (name) => {
        const getArray = () => {
          const arr = values[name];
          if (!Array.isArray(arr)) return [];
          return arr.map((item, i) => {
            if (typeof item === 'object' && item !== null) {
              return item.id ? item : { id: `${name}-${i}`, ...item };
            }
            return { id: `${name}-${i}`, value: item };
          });
        };

        const setArray = (newArray) => {
          values[name] = newArray.map(item => item.id ? item : { id: generateId(), ...item });
          dirty[name] = true;
          notify();
        };

        return {
          fields: getArray(),
          append: (value) => setArray([...getArray(), { id: generateId(), ...value }]),
          prepend: (value) => setArray([{ id: generateId(), ...value }, ...getArray()]),
          remove: (index) => setArray(getArray().filter((_, i) => i !== index)),
          swap: (a, b) => {
            const arr = [...getArray()];
            [arr[a], arr[b]] = [arr[b], arr[a]];
            setArray(arr);
          },
          update: (index, value) => {
            const arr = [...getArray()];
            arr[index] = { ...arr[index], ...value };
            setArray(arr);
          }
        };
      };

      return {
        register,
        setValue,
        reset,
        handleSubmit,
        useFieldArray,
        subscribe: (fn) => { listeners.add(fn); return () => listeners.delete(fn); },
        getValues: () => deepClone(values),
        getValue: (name) => values[name],
        validate: validateAll,
        clearErrors: (name) => {
          if (name) delete errors[name];
          else for (const k in errors) delete errors[k];
          notify();
        },
        setError: (name, msg) => { errors[name] = msg; notify(); },
        get errors() { return { ...errors }; },
        get isValid() { return Object.keys(errors).length === 0; },
        get isSubmitting() { return isSubmitting; },
        get isValidating() { return isValidating; },
        get isDirty() { return Object.values(dirty).some(Boolean); },
        get touched() { return { ...touched }; },
        get dirty() { return { ...dirty }; },
        get submitCount() { return submitCount; }
      };
    }

    // ========================================
    // Demo 1: Signup Form
    // ========================================

    function renderSignupDemo() {
      const container = document.getElementById('signup-demo');
      let submitted = false;

      const form = useForm({
        defaultValues: {
          name: '',
          email: '',
          password: '',
          confirmPassword: '',
          terms: false
        },
        validation: {
          name: [validators.required(), validators.minLength(2)],
          email: [validators.required(), validators.email()],
          password: [
            validators.required(),
            validators.minLength(8, 'Password must be at least 8 characters'),
            validators.pattern(/[A-Z]/, 'Must contain an uppercase letter'),
            validators.pattern(/[0-9]/, 'Must contain a number')
          ],
          confirmPassword: [
            validators.required(),
            validators.match('password', 'Passwords do not match')
          ],
          terms: [validators.custom((v) => v === true, 'You must accept the terms')]
        },
        mode: 'onBlur'
      });

      const getPasswordStrength = (password) => {
        if (!password) return null;
        let score = 0;
        if (password.length >= 8) score++;
        if (/[A-Z]/.test(password)) score++;
        if (/[0-9]/.test(password)) score++;
        if (/[^A-Za-z0-9]/.test(password)) score++;
        if (score <= 1) return 'weak';
        if (score <= 2) return 'medium';
        return 'strong';
      };

      const render = () => {
        const errors = form.errors;
        const password = form.getValue('password');
        const strength = getPasswordStrength(password);

        container.innerHTML = `
          <h3><span>1</span> Signup Form with Validation</h3>
          ${submitted ? `
            <div class="success-message">
              Account created successfully!
            </div>
          ` : `
            <form id="signup-form">
              <div class="form-group">
                <label>Full Name</label>
                <input type="text" name="name" class="${errors.name ? 'error' : ''}"
                       value="${form.getValue('name') || ''}" placeholder="John Doe">
                ${errors.name ? `<div class="error-message">${errors.name}</div>` : ''}
              </div>

              <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" class="${errors.email ? 'error' : ''}"
                       value="${form.getValue('email') || ''}" placeholder="john@example.com">
                ${errors.email ? `<div class="error-message">${errors.email}</div>` : ''}
              </div>

              <div class="form-group">
                <label>Password</label>
                <input type="password" name="password" class="${errors.password ? 'error' : ''}"
                       value="${form.getValue('password') || ''}" placeholder="••••••••">
                ${strength ? `
                  <div class="password-strength">
                    <div class="password-strength-bar strength-${strength}"></div>
                  </div>
                ` : ''}
                ${errors.password ? `<div class="error-message">${errors.password}</div>` : ''}
              </div>

              <div class="form-group">
                <label>Confirm Password</label>
                <input type="password" name="confirmPassword" class="${errors.confirmPassword ? 'error' : ''}"
                       value="${form.getValue('confirmPassword') || ''}" placeholder="••••••••">
                ${errors.confirmPassword ? `<div class="error-message">${errors.confirmPassword}</div>` : ''}
              </div>

              <div class="form-group">
                <label class="checkbox-group">
                  <input type="checkbox" name="terms" ${form.getValue('terms') ? 'checked' : ''}>
                  I accept the terms and conditions
                </label>
                ${errors.terms ? `<div class="error-message">${errors.terms}</div>` : ''}
              </div>

              <div class="button-group">
                <button type="submit" class="primary" ${form.isSubmitting ? 'disabled' : ''}>
                  ${form.isSubmitting ? 'Creating...' : 'Create Account'}
                </button>
                <button type="button" class="secondary" id="reset-signup">Reset</button>
              </div>
            </form>
          `}
        `;

        if (!submitted) {
          const formEl = document.getElementById('signup-form');
          formEl.querySelectorAll('input').forEach(input => {
            const reg = form.register(input.name);
            input.addEventListener('input', reg.onChange);
            input.addEventListener('blur', reg.onBlur);
            reg.ref(input);
          });

          formEl.addEventListener('submit', form.handleSubmit(
            (data) => {
              console.log('Signup data:', data);
              submitted = true;
              render();
            },
            (errors) => console.log('Validation errors:', errors)
          ));

          document.getElementById('reset-signup').addEventListener('click', () => {
            form.reset();
            render();
          });
        }
      };

      form.subscribe(render);
      render();
    }

    // ========================================
    // Demo 2: Async Validation
    // ========================================

    function renderAsyncDemo() {
      const container = document.getElementById('async-demo');

      // Simulate API check for username availability
      const checkUsername = async (username) => {
        await new Promise(r => setTimeout(r, 1000));
        const taken = ['admin', 'user', 'test', 'john'];
        return !taken.includes(username.toLowerCase());
      };

      let asyncStatus = {};
      let submitted = false;

      const form = useForm({
        defaultValues: {
          username: '',
          email: ''
        },
        validation: {
          username: [
            validators.required(),
            validators.minLength(3),
            validators.pattern(/^[a-zA-Z0-9_]+$/, 'Only letters, numbers and underscores'),
            validators.async(async (value) => {
              asyncStatus.username = 'loading';
              render();
              const available = await checkUsername(value);
              asyncStatus.username = available ? 'valid' : 'invalid';
              render();
              return available;
            }, 'Username is already taken')
          ],
          email: [validators.required(), validators.email()]
        },
        mode: 'onBlur'
      });

      const render = () => {
        const errors = form.errors;

        container.innerHTML = `
          <h3><span>2</span> Async Validation</h3>
          ${submitted ? `
            <div class="success-message">Username reserved!</div>
          ` : `
            <form id="async-form">
              <div class="form-group">
                <label>
                  Username
                  <span class="async-indicator ${asyncStatus.username || ''}"></span>
                </label>
                <input type="text" name="username" class="${errors.username ? 'error' : ''}"
                       value="${form.getValue('username') || ''}" placeholder="Choose a username">
                ${errors.username ? `<div class="error-message">${errors.username}</div>` : ''}
                <small style="color: #666; font-size: 11px;">Try: admin, user, test (taken)</small>
              </div>

              <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" class="${errors.email ? 'error' : ''}"
                       value="${form.getValue('email') || ''}" placeholder="your@email.com">
                ${errors.email ? `<div class="error-message">${errors.email}</div>` : ''}
              </div>

              <div class="button-group">
                <button type="submit" class="primary" ${form.isSubmitting || form.isValidating ? 'disabled' : ''}>
                  ${form.isSubmitting ? 'Checking...' : 'Reserve Username'}
                </button>
              </div>
            </form>
          `}
        `;

        if (!submitted) {
          const formEl = document.getElementById('async-form');
          formEl.querySelectorAll('input').forEach(input => {
            const reg = form.register(input.name);
            input.addEventListener('input', reg.onChange);
            input.addEventListener('blur', reg.onBlur);
            reg.ref(input);
          });

          formEl.addEventListener('submit', form.handleSubmit(
            (data) => {
              console.log('Username reserved:', data);
              submitted = true;
              render();
            }
          ));
        }
      };

      form.subscribe(render);
      render();
    }

    // ========================================
    // Demo 3: Field Array
    // ========================================

    function renderArrayDemo() {
      const container = document.getElementById('array-demo');

      const form = useForm({
        defaultValues: {
          teamName: '',
          members: [
            { id: '1', name: 'Alice', role: 'Developer' },
            { id: '2', name: 'Bob', role: 'Designer' }
          ]
        },
        validation: {
          teamName: [validators.required()]
        },
        mode: 'onChange'
      });

      const fieldArray = form.useFieldArray('members');

      const render = () => {
        const errors = form.errors;
        const members = fieldArray.fields;

        container.innerHTML = `
          <h3><span>3</span> Dynamic Field Array</h3>
          <form id="array-form">
            <div class="form-group">
              <label>Team Name</label>
              <input type="text" name="teamName" class="${errors.teamName ? 'error' : ''}"
                     value="${form.getValue('teamName') || ''}" placeholder="Enter team name">
              ${errors.teamName ? `<div class="error-message">${errors.teamName}</div>` : ''}
            </div>

            <label>Team Members</label>
            <div id="members-list">
              ${members.map((member, index) => `
                <div class="field-array-item" data-index="${index}">
                  <input type="text" name="member-name-${index}" value="${member.name || ''}" placeholder="Name">
                  <input type="text" name="member-role-${index}" value="${member.role || ''}" placeholder="Role">
                  <button type="button" class="danger remove-member" data-index="${index}">×</button>
                </div>
              `).join('')}
            </div>

            <div class="button-group">
              <button type="button" class="secondary" id="add-member">+ Add Member</button>
              <button type="submit" class="primary">Save Team</button>
            </div>

            <div class="form-state">
              <pre>${JSON.stringify(form.getValues(), null, 2)}</pre>
            </div>
          </form>
        `;

        const formEl = document.getElementById('array-form');

        // Team name input
        const teamNameInput = formEl.querySelector('[name="teamName"]');
        const teamNameReg = form.register('teamName');
        teamNameInput.addEventListener('input', teamNameReg.onChange);
        teamNameInput.addEventListener('blur', teamNameReg.onBlur);

        // Member inputs
        members.forEach((member, index) => {
          const nameInput = formEl.querySelector(`[name="member-name-${index}"]`);
          const roleInput = formEl.querySelector(`[name="member-role-${index}"]`);

          nameInput.addEventListener('input', (e) => {
            fieldArray.update(index, { name: e.target.value, role: member.role });
          });
          roleInput.addEventListener('input', (e) => {
            fieldArray.update(index, { name: member.name, role: e.target.value });
          });
        });

        // Remove buttons
        formEl.querySelectorAll('.remove-member').forEach(btn => {
          btn.addEventListener('click', () => {
            fieldArray.remove(parseInt(btn.dataset.index));
            render();
          });
        });

        // Add button
        document.getElementById('add-member').addEventListener('click', () => {
          fieldArray.append({ name: '', role: '' });
          render();
        });

        formEl.addEventListener('submit', form.handleSubmit(
          (data) => {
            console.log('Team saved:', data);
            alert('Team saved! Check console.');
          }
        ));
      };

      form.subscribe(render);
      render();
    }

    // ========================================
    // Demo 4: Complex Form
    // ========================================

    function renderComplexDemo() {
      const container = document.getElementById('complex-demo');

      const form = useForm({
        defaultValues: {
          personalInfo: {
            firstName: '',
            lastName: '',
            age: ''
          },
          contact: {
            email: '',
            phone: ''
          },
          preferences: {
            newsletter: false,
            notifications: 'email'
          }
        },
        validation: {
          'personalInfo.firstName': [validators.required()],
          'personalInfo.lastName': [validators.required()],
          'personalInfo.age': [validators.min(18, 'Must be 18 or older')],
          'contact.email': [validators.required(), validators.email()]
        },
        mode: 'onBlur'
      });

      // Flatten nested values for form binding
      const flattenValues = (obj, prefix = '') => {
        const result = {};
        for (const key in obj) {
          const path = prefix ? `${prefix}.${key}` : key;
          if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
            Object.assign(result, flattenValues(obj[key], path));
          } else {
            result[path] = obj[key];
          }
        }
        return result;
      };

      const setNestedValue = (path, value) => {
        const values = form.getValues();
        const parts = path.split('.');
        let current = values;
        for (let i = 0; i < parts.length - 1; i++) {
          current = current[parts[i]];
        }
        current[parts[parts.length - 1]] = value;
        form.setValue(path, value);
      };

      const getNestedValue = (path) => {
        const values = form.getValues();
        return path.split('.').reduce((obj, key) => obj?.[key], values);
      };

      const render = () => {
        const errors = form.errors;

        container.innerHTML = `
          <h3><span>4</span> Complex Form with All Features</h3>
          <form id="complex-form">
            <h4 style="margin: 15px 0 10px; color: #888;">Personal Information</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div class="form-group">
                <label>First Name</label>
                <input type="text" name="personalInfo.firstName"
                       class="${errors['personalInfo.firstName'] ? 'error' : ''}"
                       value="${getNestedValue('personalInfo.firstName') || ''}" placeholder="First">
                ${errors['personalInfo.firstName'] ? `<div class="error-message">${errors['personalInfo.firstName']}</div>` : ''}
              </div>
              <div class="form-group">
                <label>Last Name</label>
                <input type="text" name="personalInfo.lastName"
                       class="${errors['personalInfo.lastName'] ? 'error' : ''}"
                       value="${getNestedValue('personalInfo.lastName') || ''}" placeholder="Last">
                ${errors['personalInfo.lastName'] ? `<div class="error-message">${errors['personalInfo.lastName']}</div>` : ''}
              </div>
            </div>
            <div class="form-group">
              <label>Age</label>
              <input type="number" name="personalInfo.age"
                     class="${errors['personalInfo.age'] ? 'error' : ''}"
                     value="${getNestedValue('personalInfo.age') || ''}" placeholder="Age">
              ${errors['personalInfo.age'] ? `<div class="error-message">${errors['personalInfo.age']}</div>` : ''}
            </div>

            <h4 style="margin: 15px 0 10px; color: #888;">Contact</h4>
            <div class="form-group">
              <label>Email</label>
              <input type="email" name="contact.email"
                     class="${errors['contact.email'] ? 'error' : ''}"
                     value="${getNestedValue('contact.email') || ''}" placeholder="email@example.com">
              ${errors['contact.email'] ? `<div class="error-message">${errors['contact.email']}</div>` : ''}
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" name="contact.phone"
                     value="${getNestedValue('contact.phone') || ''}" placeholder="+1 234 567 8900">
            </div>

            <h4 style="margin: 15px 0 10px; color: #888;">Preferences</h4>
            <div class="form-group">
              <label class="checkbox-group">
                <input type="checkbox" name="preferences.newsletter"
                       ${getNestedValue('preferences.newsletter') ? 'checked' : ''}>
                Subscribe to newsletter
              </label>
            </div>
            <div class="form-group">
              <label>Notification Method</label>
              <select name="preferences.notifications">
                <option value="email" ${getNestedValue('preferences.notifications') === 'email' ? 'selected' : ''}>Email</option>
                <option value="sms" ${getNestedValue('preferences.notifications') === 'sms' ? 'selected' : ''}>SMS</option>
                <option value="push" ${getNestedValue('preferences.notifications') === 'push' ? 'selected' : ''}>Push</option>
                <option value="none" ${getNestedValue('preferences.notifications') === 'none' ? 'selected' : ''}>None</option>
              </select>
            </div>

            <div class="button-group">
              <button type="submit" class="primary" ${form.isSubmitting ? 'disabled' : ''}>
                ${form.isSubmitting ? 'Saving...' : 'Save Profile'}
              </button>
              <button type="button" class="secondary" id="reset-complex">Reset</button>
            </div>

            <div class="form-state">
              <strong>Form State:</strong>
              <pre>${JSON.stringify({
                values: form.getValues(),
                errors: form.errors,
                isDirty: form.isDirty,
                isValid: form.isValid
              }, null, 2)}</pre>
            </div>
          </form>
        `;

        const formEl = document.getElementById('complex-form');

        formEl.querySelectorAll('input, select').forEach(input => {
          const name = input.name;

          input.addEventListener('input', (e) => {
            let value;
            if (input.type === 'checkbox') {
              value = e.target.checked;
            } else if (input.type === 'number') {
              value = e.target.value === '' ? '' : parseFloat(e.target.value);
            } else {
              value = e.target.value;
            }
            setNestedValue(name, value);
            render();
          });

          input.addEventListener('blur', () => {
            form.validate().then(() => render());
          });
        });

        formEl.addEventListener('submit', form.handleSubmit(
          (data) => {
            console.log('Profile saved:', data);
            alert('Profile saved! Check console.');
          }
        ));

        document.getElementById('reset-complex').addEventListener('click', () => {
          form.reset();
          render();
        });
      };

      form.subscribe(render);
      render();
    }

    // ========================================
    // Initialize Demos
    // ========================================

    renderSignupDemo();
    renderAsyncDemo();
    renderArrayDemo();
    renderComplexDemo();

    console.log('Zylix Form Demo loaded');
  </script>
</body>
</html>
