# iOS E2E Tests with XCUITest
# Runs Zylix E2E tests on iOS Simulator
#
# This workflow runs XCUITest-based E2E tests for Zylix iOS apps.
# It uses the ZylixTestContext framework for comprehensive UI testing.

name: iOS E2E Tests

on:
  push:
    branches: [develop, main]
    paths:
      - 'platforms/ios/**'
      - 'core/**'
      - '.github/workflows/ios-e2e-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'platforms/ios/**'
      - 'core/**'
  workflow_dispatch:
    inputs:
      device:
        description: 'iOS Simulator device'
        required: false
        default: 'iPhone 16'
        type: choice
        options:
          - 'iPhone 16'
          - 'iPhone 16 Pro'
          - 'iPhone 16 Pro Max'
          - 'iPad Pro 13-inch (M4)'
      ios_version:
        description: 'iOS version'
        required: false
        default: '18.4'
        type: choice
        options:
          - '18.4'
          - '18.5'
          - '18.6'

concurrency:
  group: ios-e2e-${{ github.ref }}
  cancel-in-progress: true

env:
  # Use Xcode 16.1 which is available on macos-latest (macOS 14)
  XCODE_VERSION: '16.1'
  DEFAULT_DEVICE: 'iPhone 16'
  DEFAULT_IOS_VERSION: '18.4'

jobs:
  # ============================================================================
  # Build Zylix Core for iOS
  # ============================================================================
  build-core:
    name: Build Core (iOS)
    runs-on: macos-latest
    timeout-minutes: 15
    outputs:
      core-built: ${{ steps.build.outcome }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2

      - name: Cache Zig Build
        uses: actions/cache@v5
        with:
          path: |
            core/zig-cache
            core/zig-out
          key: zig-ios-${{ runner.os }}-${{ hashFiles('core/**/*.zig') }}
          restore-keys: |
            zig-ios-${{ runner.os }}-

      - name: Build Core for iOS
        id: build
        working-directory: core
        run: |
          # Build the core library for iOS (uses the dedicated ios build step)
          zig build ios
          echo "Core built successfully for iOS target"

  # ============================================================================
  # Run XCUITest E2E Tests
  # ============================================================================
  e2e-tests:
    name: E2E Tests (${{ matrix.device }})
    runs-on: macos-latest
    needs: build-core
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - device: 'iPhone 16'
            ios: '18.4'
          - device: 'iPhone 16 Pro'
            ios: '18.4'
          # Add iPad testing for tablet layout verification
          - device: 'iPad Pro 13-inch (M4)'
            ios: '18.4'
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Setup Simulator
        run: |
          # Get device UDID
          DEVICE="${{ matrix.device }}"
          IOS_VERSION="${{ matrix.ios }}"

          # List available simulators
          xcrun simctl list devices available

          # Find UDID for specific device in specific iOS version section
          # The simctl output has format:
          #   -- iOS 18.4 --
          #       iPhone 16 (UDID) (Shutdown)
          UDID=$(xcrun simctl list devices available | awk -v ios="iOS $IOS_VERSION" -v dev="$DEVICE" '
            $0 ~ "-- " ios " --" { in_section=1; next }
            /^-- / { in_section=0 }
            in_section && $0 ~ dev {
              match($0, /\([A-Fa-f0-9-]{36}\)/);
              if (RSTART) {
                print substr($0, RSTART+1, 36);
                exit
              }
            }
          ')

          if [ -n "$UDID" ]; then
            echo "Found simulator: $UDID"
            xcrun simctl boot "$UDID" || true
            echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          else
            echo "::warning::Could not find exact simulator match, will use default"
          fi

      - name: Cache Xcode Build
        uses: actions/cache@v5
        with:
          path: |
            platforms/ios/build
            ~/Library/Developer/Xcode/DerivedData
          key: xcode-ios-${{ runner.os }}-${{ hashFiles('platforms/ios/**/*.swift') }}
          restore-keys: |
            xcode-ios-${{ runner.os }}-

      - name: Build iOS App
        working-directory: platforms/ios
        run: |
          # Build the app for testing
          xcodebuild build-for-testing \
            -project Zylix.xcodeproj \
            -scheme Zylix \
            -destination "platform=iOS Simulator,name=${{ matrix.device }},OS=${{ matrix.ios }}" \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty || true

      - name: Run XCUITest E2E Tests
        working-directory: platforms/ios
        run: |
          # Run UI tests
          xcodebuild test-without-building \
            -project Zylix.xcodeproj \
            -scheme ZylixUITests \
            -destination "platform=iOS Simulator,name=${{ matrix.device }},OS=${{ matrix.ios }}" \
            -derivedDataPath build \
            -resultBundlePath TestResults.xcresult \
            | xcpretty --report junit --output TestResults.xml || true

      - name: Extract Test Results
        if: always()
        working-directory: platforms/ios
        run: |
          # Extract screenshots from test results
          if [ -d "TestResults.xcresult" ]; then
            xcrun xcresulttool get --legacy --format json --path TestResults.xcresult > test_results.json

            # Extract summary
            echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Parse results (basic parsing)
            if command -v jq &> /dev/null; then
              TESTS_COUNT=$(jq -r '.metrics.testsCount.value // "N/A"' test_results.json 2>/dev/null || echo "N/A")
              PASSED=$(jq -r '.metrics.testsPassedCount.value // "N/A"' test_results.json 2>/dev/null || echo "N/A")
              FAILED=$(jq -r '.metrics.testsFailedCount.value // "N/A"' test_results.json 2>/dev/null || echo "N/A")

              echo "- **Device**: ${{ matrix.device }}" >> $GITHUB_STEP_SUMMARY
              echo "- **iOS Version**: ${{ matrix.ios }}" >> $GITHUB_STEP_SUMMARY
              echo "- **Total Tests**: $TESTS_COUNT" >> $GITHUB_STEP_SUMMARY
              echo "- **Passed**: $PASSED" >> $GITHUB_STEP_SUMMARY
              echo "- **Failed**: $FAILED" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ios-e2e-results-${{ matrix.device }}-${{ matrix.ios }}
          path: |
            platforms/ios/TestResults.xcresult
            platforms/ios/TestResults.xml
            platforms/ios/test_results.json
          retention-days: 30

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ios-screenshots-${{ matrix.device }}-${{ matrix.ios }}
          path: platforms/ios/build/**/Attachments/**/*.png
          retention-days: 14
          if-no-files-found: ignore

  # ============================================================================
  # Accessibility Tests
  # ============================================================================
  accessibility-tests:
    name: Accessibility Audit
    runs-on: macos-latest
    needs: build-core
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Build for Accessibility Testing
        working-directory: platforms/ios
        run: |
          xcodebuild build-for-testing \
            -project Zylix.xcodeproj \
            -scheme Zylix \
            -destination "platform=iOS Simulator,name=${{ env.DEFAULT_DEVICE }},OS=${{ env.DEFAULT_IOS_VERSION }}" \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty || true

      - name: Run Accessibility Tests
        working-directory: platforms/ios
        run: |
          # Run accessibility-specific tests
          xcodebuild test-without-building \
            -project Zylix.xcodeproj \
            -scheme ZylixUITests \
            -destination "platform=iOS Simulator,name=${{ env.DEFAULT_DEVICE }},OS=${{ env.DEFAULT_IOS_VERSION }}" \
            -derivedDataPath build \
            -only-testing:ZylixUITests/ZylixSampleUITests/testAccessibilityIdentifiersExist \
            -only-testing:ZylixUITests/ZylixSampleUITests/testVoiceOverLabelsExist \
            | xcpretty || true

      - name: Accessibility Audit Summary
        if: always()
        run: |
          echo "## Accessibility Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Accessibility tests verify:" >> $GITHUB_STEP_SUMMARY
          echo "- Accessibility identifiers for UI automation" >> $GITHUB_STEP_SUMMARY
          echo "- VoiceOver labels for screen reader support" >> $GITHUB_STEP_SUMMARY
          echo "- Semantic element structure" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Performance Baseline Tests
  # ============================================================================
  performance-tests:
    name: Performance Baseline
    runs-on: macos-latest
    needs: build-core
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Build for Performance Testing
        working-directory: platforms/ios
        run: |
          xcodebuild build-for-testing \
            -project Zylix.xcodeproj \
            -scheme Zylix \
            -destination "platform=iOS Simulator,name=${{ env.DEFAULT_DEVICE }},OS=${{ env.DEFAULT_IOS_VERSION }}" \
            -derivedDataPath build \
            -configuration Release \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty || true

      - name: Run Performance Tests
        working-directory: platforms/ios
        run: |
          xcodebuild test-without-building \
            -project Zylix.xcodeproj \
            -scheme ZylixUITests \
            -destination "platform=iOS Simulator,name=${{ env.DEFAULT_DEVICE }},OS=${{ env.DEFAULT_IOS_VERSION }}" \
            -derivedDataPath build \
            -only-testing:ZylixUITests/ZylixPerformanceUITests \
            -resultBundlePath PerformanceResults.xcresult \
            | xcpretty || true

      - name: Extract Performance Metrics
        if: always()
        working-directory: platforms/ios
        run: |
          if [ -d "PerformanceResults.xcresult" ]; then
            xcrun xcresulttool get --legacy --format json --path PerformanceResults.xcresult > perf_results.json

            echo "## Performance Metrics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Performance tests measure:" >> $GITHUB_STEP_SUMMARY
            echo "- App launch time" >> $GITHUB_STEP_SUMMARY
            echo "- Scrolling performance" >> $GITHUB_STEP_SUMMARY
            echo "- Memory usage patterns" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Performance Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ios-performance-results
          path: |
            platforms/ios/PerformanceResults.xcresult
            platforms/ios/perf_results.json
          retention-days: 30

  # ============================================================================
  # Test Report Summary
  # ============================================================================
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-tests, accessibility-tests, performance-tests]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# iOS E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility | ${{ needs.accessibility-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | ${{ needs.performance-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test results and screenshots are available as workflow artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Check for Failures
        if: needs.e2e-tests.result == 'failure' || needs.accessibility-tests.result == 'failure' || needs.performance-tests.result == 'failure'
        run: |
          echo "::warning::Some iOS E2E tests failed. Check the workflow artifacts for details."
