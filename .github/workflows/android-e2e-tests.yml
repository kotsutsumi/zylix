# Android Build & Tests
# Runs unit tests, lint, and build verification for Zylix Android
#
# E2E tests removed - use workflow_dispatch for manual E2E testing when needed

name: Android Build & Tests

on:
  push:
    branches: [develop, main]
    paths:
      - 'platforms/android/**'
      - 'core/**'
      - '.github/workflows/android-e2e-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'platforms/android/**'
      - 'core/**'

concurrency:
  group: android-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '17'

jobs:
  # ============================================================================
  # Build Zylix Core for Android (shared by all jobs)
  # ============================================================================
  build-core:
    name: Build Core
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2

      - name: Cache Zig Build
        uses: actions/cache@v5
        with:
          path: |
            core/zig-cache
            core/zig-out
          key: zig-android-${{ runner.os }}-${{ hashFiles('core/**/*.zig') }}

      - name: Build Core for Android
        working-directory: core
        run: zig build android

      - name: Upload Android Libraries
        uses: actions/upload-artifact@v6
        with:
          name: android-native-libs
          path: core/zig-out/android/
          retention-days: 1

  # ============================================================================
  # Build Android Library
  # ============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: build-core
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Download Native Libraries
        uses: actions/download-artifact@v7
        with:
          name: android-native-libs
          path: core/zig-out/android/

      - name: Install Native Libraries
        run: |
          JNILIBS="platforms/android/zylix-android/src/main/jniLibs"
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            if [ -d "core/zig-out/android/$abi" ]; then
              mkdir -p "$JNILIBS/$abi"
              cp core/zig-out/android/$abi/*.so "$JNILIBS/$abi/" || true
            fi
          done

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build Library
        working-directory: platforms/android
        run: |
          chmod +x ./gradlew
          ./gradlew :zylix-android:assembleDebug :zylix-android:assembleRelease

  # ============================================================================
  # Unit Tests
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build-core
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Download Native Libraries
        uses: actions/download-artifact@v7
        with:
          name: android-native-libs
          path: core/zig-out/android/

      - name: Install Native Libraries
        run: |
          JNILIBS="platforms/android/zylix-android/src/main/jniLibs"
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            if [ -d "core/zig-out/android/$abi" ]; then
              mkdir -p "$JNILIBS/$abi"
              cp core/zig-out/android/$abi/*.so "$JNILIBS/$abi/" || true
            fi
          done

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run Unit Tests
        working-directory: platforms/android
        run: |
          chmod +x ./gradlew
          ./gradlew :zylix-android:test --continue

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: android-unit-test-results
          path: platforms/android/zylix-android/build/reports/tests
          retention-days: 7
          if-no-files-found: ignore

  # ============================================================================
  # Lint
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: build-core
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Download Native Libraries
        uses: actions/download-artifact@v7
        with:
          name: android-native-libs
          path: core/zig-out/android/

      - name: Install Native Libraries
        run: |
          JNILIBS="platforms/android/zylix-android/src/main/jniLibs"
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            if [ -d "core/zig-out/android/$abi" ]; then
              mkdir -p "$JNILIBS/$abi"
              cp core/zig-out/android/$abi/*.so "$JNILIBS/$abi/" || true
            fi
          done

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run Lint
        working-directory: platforms/android
        run: |
          chmod +x ./gradlew
          ./gradlew :zylix-android:lint

      - name: Upload Lint Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: android-lint-results
          path: platforms/android/zylix-android/build/reports/lint-results*
          retention-days: 7
          if-no-files-found: ignore
