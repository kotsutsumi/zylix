#!/usr/bin/env bash
#
# Zylix CLI - Build and development tool
#
# Usage:
#   zylix build <platform> [options]
#   zylix run <platform> [options]
#   zylix test
#   zylix clean
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
CORE_DIR="$PROJECT_ROOT/core"
PLATFORMS_DIR="$PROJECT_ROOT/platforms"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# === Utility Functions ===

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

check_dependencies() {
    local missing=()

    if ! command -v zig &> /dev/null; then
        missing+=("zig")
    fi

    if [[ ${#missing[@]} -gt 0 ]]; then
        log_error "Missing dependencies: ${missing[*]}"
        exit 1
    fi
}

# === Core Build Functions ===

build_core() {
    local target="$1"
    local optimize="${2:-ReleaseFast}"

    log_info "Building Zylix Core for $target..."

    cd "$CORE_DIR"

    case "$target" in
        native)
            zig build -Doptimize="$optimize"
            ;;
        ios)
            zig build ios -Doptimize="$optimize"
            ;;
        ios-sim)
            zig build ios-sim -Doptimize="$optimize"
            ;;
        android-arm64)
            zig build android-arm64 -Doptimize="$optimize"
            ;;
        android-x64)
            zig build android-x64 -Doptimize="$optimize"
            ;;
        macos-arm64)
            zig build macos-arm64 -Doptimize="$optimize"
            ;;
        macos-x64)
            zig build macos-x64 -Doptimize="$optimize"
            ;;
        all)
            zig build all -Doptimize="$optimize"
            ;;
        *)
            log_error "Unknown target: $target"
            exit 1
            ;;
    esac

    log_success "Core build complete: $target"
}

# === iOS Build Functions ===

build_ios() {
    local config="${1:-Release}"
    local simulator="${2:-false}"

    check_ios_dependencies

    log_info "Building iOS app ($config)..."

    # Build Zig core
    if [[ "$simulator" == "true" ]]; then
        build_core "ios-sim" "ReleaseFast"
    else
        build_core "ios" "ReleaseFast"
    fi

    # Copy library to iOS project
    copy_ios_library "$simulator"

    # Build iOS app with xcodebuild
    local sdk="iphoneos"
    local destination="generic/platform=iOS"

    if [[ "$simulator" == "true" ]]; then
        sdk="iphonesimulator"
        destination="platform=iOS Simulator,name=iPhone 15"
    fi

    cd "$PLATFORMS_DIR/ios"

    if [[ -f "Zylix.xcodeproj/project.pbxproj" ]]; then
        xcodebuild \
            -project Zylix.xcodeproj \
            -scheme Zylix \
            -configuration "$config" \
            -sdk "$sdk" \
            -destination "$destination" \
            -derivedDataPath build \
            build

        log_success "iOS build complete!"
    else
        log_warn "iOS project not found. Run 'zylix init ios' first."
    fi
}

run_ios() {
    local simulator="${1:-true}"

    build_ios "Debug" "$simulator"

    if [[ "$simulator" == "true" ]]; then
        log_info "Launching iOS Simulator..."

        # Find built app
        local app_path
        app_path=$(find "$PLATFORMS_DIR/ios/build" -name "*.app" -type d | head -1)

        if [[ -n "$app_path" ]]; then
            # Boot simulator if needed
            xcrun simctl boot "iPhone 15" 2>/dev/null || true

            # Install and launch
            xcrun simctl install booted "$app_path"
            xcrun simctl launch booted "com.zylix.app"

            log_success "App launched in simulator"
        else
            log_error "Built app not found"
        fi
    fi
}

check_ios_dependencies() {
    if ! command -v xcodebuild &> /dev/null; then
        log_error "Xcode command line tools not found"
        exit 1
    fi
}

copy_ios_library() {
    local simulator="${1:-false}"

    local src_dir="$CORE_DIR/zig-out/ios"
    if [[ "$simulator" == "true" ]]; then
        src_dir="$CORE_DIR/zig-out/ios-simulator"
    fi

    local dst_dir="$PLATFORMS_DIR/ios/Zylix/Libraries"
    mkdir -p "$dst_dir"

    if [[ -f "$src_dir/libzylix.a" ]]; then
        cp "$src_dir/libzylix.a" "$dst_dir/"
        log_info "Copied libzylix.a to iOS project"
    fi
}

# === Android Build Functions ===

build_android() {
    local variant="${1:-release}"

    check_android_dependencies

    log_info "Building Android app ($variant)..."

    # Build Zig core for both architectures
    build_core "android-arm64" "ReleaseFast"
    build_core "android-x64" "ReleaseFast"

    # Copy libraries to Android project
    copy_android_libraries

    # Build Android app with Gradle
    cd "$PLATFORMS_DIR/android"

    if [[ -f "gradlew" ]]; then
        ./gradlew "assemble${variant^}"
        log_success "Android build complete!"
        log_info "APK: $PLATFORMS_DIR/android/app/build/outputs/apk/$variant/"
    else
        log_warn "Android project not found. Run 'zylix init android' first."
    fi
}

run_android() {
    build_android "debug"

    log_info "Installing and launching on connected device/emulator..."

    cd "$PLATFORMS_DIR/android"

    if [[ -f "gradlew" ]]; then
        ./gradlew installDebug

        # Launch app
        adb shell am start -n "com.zylix.app/.MainActivity"

        log_success "App launched on device"
    fi
}

check_android_dependencies() {
    if [[ -z "${ANDROID_HOME:-}" ]]; then
        log_error "ANDROID_HOME not set"
        exit 1
    fi
}

copy_android_libraries() {
    local jni_dir="$PLATFORMS_DIR/android/app/src/main/jniLibs"

    mkdir -p "$jni_dir/arm64-v8a"
    mkdir -p "$jni_dir/x86_64"

    if [[ -f "$CORE_DIR/zig-out/android-arm64/libzylix.a" ]]; then
        cp "$CORE_DIR/zig-out/android-arm64/libzylix.a" "$jni_dir/arm64-v8a/"
        log_info "Copied libzylix.a to arm64-v8a"
    fi

    if [[ -f "$CORE_DIR/zig-out/android-x64/libzylix.a" ]]; then
        cp "$CORE_DIR/zig-out/android-x64/libzylix.a" "$jni_dir/x86_64/"
        log_info "Copied libzylix.a to x86_64"
    fi
}

# === Test Functions ===

run_tests() {
    log_info "Running Zylix Core tests..."

    cd "$CORE_DIR"
    zig build test

    log_success "All tests passed!"
}

# === Clean Functions ===

clean() {
    log_info "Cleaning build artifacts..."

    rm -rf "$CORE_DIR/zig-out"
    rm -rf "$CORE_DIR/zig-cache"
    rm -rf "$CORE_DIR/.zig-cache"

    if [[ -d "$PLATFORMS_DIR/ios/build" ]]; then
        rm -rf "$PLATFORMS_DIR/ios/build"
    fi

    if [[ -d "$PLATFORMS_DIR/android/app/build" ]]; then
        rm -rf "$PLATFORMS_DIR/android/app/build"
    fi

    log_success "Clean complete!"
}

# === Help ===

show_help() {
    cat << EOF
Zylix CLI - Build and development tool

Usage:
    zylix <command> [options]

Commands:
    build <platform>    Build for specified platform
        ios             Build iOS app
        ios --simulator Build iOS app for simulator
        android         Build Android app
        core [target]   Build Zig core only
        all             Build for all platforms

    run <platform>      Build and run on device/simulator
        ios             Run on iOS Simulator
        android         Run on Android device/emulator

    test                Run Zylix Core tests

    clean               Remove all build artifacts

Options:
    --release           Build in release mode (default)
    --debug             Build in debug mode
    --simulator         Target simulator/emulator
    -h, --help          Show this help message

Examples:
    zylix build ios
    zylix build ios --simulator
    zylix build android
    zylix run ios
    zylix run android
    zylix test
    zylix clean
EOF
}

# === Main ===

main() {
    check_dependencies

    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        build)
            local platform="${1:-}"
            shift || true

            case "$platform" in
                ios)
                    local simulator="false"
                    for arg in "$@"; do
                        case "$arg" in
                            --simulator) simulator="true" ;;
                        esac
                    done
                    build_ios "Release" "$simulator"
                    ;;
                android)
                    build_android "release"
                    ;;
                core)
                    build_core "${1:-native}" "${2:-ReleaseFast}"
                    ;;
                all)
                    build_core "all"
                    ;;
                *)
                    log_error "Unknown platform: $platform"
                    show_help
                    exit 1
                    ;;
            esac
            ;;
        run)
            local platform="${1:-}"
            case "$platform" in
                ios)
                    run_ios "true"
                    ;;
                android)
                    run_android
                    ;;
                *)
                    log_error "Unknown platform: $platform"
                    exit 1
                    ;;
            esac
            ;;
        test)
            run_tests
            ;;
        clean)
            clean
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            log_error "Unknown command: $cmd"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
